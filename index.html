<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; padding:15px;}
h1 { text-align:center; margin-bottom:20px; }

.card {
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:20px;
  overflow-x:auto;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

table {
  width:100%;
  border-collapse: collapse;
  min-width:700px;
  table-layout: fixed;
}

th, td {
  padding:10px;
  text-align:center;
  border-bottom:1px solid #334155;
  font-size:13px;
  white-space:nowrap;
}

thead th { position: sticky; top:0; background:#334155; z-index:1; }

tr:nth-child(even){ background:#1e293b; }
tr:hover { background:#334155; transition:0.2s; }

.positive { color:#22c55e; font-weight:bold; }
.negative { color:#ef4444; font-weight:bold; }
.neutral { color:white; }

.big { font-size:22px; font-weight:bold; }

.timebox { text-align:right; font-size:12px; opacity:0.8; margin-top:5px; }

td span {
  font-size:10px;
  color:#94a3b8;
  display:inline;
  margin-left:4px;
}

.daily-positive { color:#22c55e; font-weight:bold; }
.daily-negative { color:#ef4444; font-weight:bold; }
.daily-neutral { color:white; }

#addStockBtn {
  background:#2563eb;
  border:none;
  padding:10px 15px;
  border-radius:5px;
  cursor:pointer;
  color:white;
  margin-bottom:15px;
}

.stock-card {
  background:#1e293b;
  margin:8px 0;
  padding:10px;
  border-radius:8px;
}

@media screen and (max-width:768px){
  table { display:none; }
  .stock-card { display:block; }
}
@media screen and (min-width:769px){
  .stock-card { display:none; }
}
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
  <div class="big" id="totalProfit">Toplam Kar: -</div>
  <div class="timebox" id="liveClock"></div>
  <div class="timebox" id="lastUpdate"></div>
  <button id="addStockBtn">Hisse Ekle</button>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet(TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri(TL)</th>
  <th>AnlÄ±k Fiyat(TL)</th>
  <th>K/Z(TL)</th>
  <th>K/Z(%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>

<div id="mobileCards"></div>
</div>

<script>
// ---------------------
// PORTFÃ–Y
// ---------------------
let portfolio = JSON.parse(localStorage.getItem("portfolio") || "[]");

// ---------------------
// FORMAT
// ---------------------
function formatNumber(num) {
  return num.toLocaleString("tr-TR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
}

// ---------------------
// SAAT
// ---------------------
function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").innerText =
    "AnlÄ±k Saat: " + now.toLocaleTimeString("tr-TR");
}

// ---------------------
// API'DEN FÄ°YAT Ã‡EK
// ---------------------
async function fetchPrices(symbols) {
  try {
    const response = await fetch(`https://bist-portfoy.vercel.app/api/price?symbols=${symbols}`);
    return await response.json();
  } catch {
    return null;
  }
}

// ---------------------
// PORTFÃ–Y GÃœNCELLE
// ---------------------
async function updatePortfolio() {
  if(portfolio.length === 0){
    document.getElementById("portfolioBody").innerHTML = "<tr><td colspan='7'>Hisse eklemediniz</td></tr>";
    document.getElementById("mobileCards").innerHTML = "";
    return;
  }

  const tbody = document.getElementById("portfolioBody");
  const mobileDiv = document.getElementById("mobileCards");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";
  mobileDiv.innerHTML = "";

  const symbols = portfolio.map(s => s.code).join(",");
  const prices = await fetchPrices(symbols);

  if(!prices){
    tbody.innerHTML = "<tr><td colspan='7'>API HatasÄ±</td></tr>";
    return;
  }

  let totalValue = 0;
  let totalCost = 0;

  tbody.innerHTML = "";

  portfolio.forEach(stock => {
    const stockData = prices[stock.code];
    if(!stockData) return;

    const price = stockData.price;
    const value = price * stock.lot;
    const profitTL = value - stock.cost;
    const profitPercent = (profitTL / stock.cost) * 100;

    const priceDiffPercent = ((price - (stockData.prevClose || price)) / (stockData.prevClose || price)) * 100;

    totalValue += value;
    totalCost += stock.cost;

    const priceColor = priceDiffPercent>0?"positive":priceDiffPercent<0?"negative":"neutral";
    const profitColor = profitTL>=0?"positive":"negative";

    // PC Tablo
    tbody.innerHTML += `
      <tr>
        <td>${stock.code}</td>
        <td>${stock.lot}</td>
        <td>${formatNumber(stock.cost)}</td>
        <td>${formatNumber(value)}</td>
        <td class="${priceColor}">
          ${formatNumber(price)}
          <span>
            (${formatNumber(stockData.prevClose || price)} ${priceDiffPercent>=0?'+':''}${priceDiffPercent.toFixed(2)}%)
          </span>
        </td>
        <td class="${profitColor}">${formatNumber(profitTL)}</td>
        <td class="${profitColor}">${profitPercent.toFixed(2)}%</td>
      </tr>
    `;

    // Mobil Kart
    mobileDiv.innerHTML += `
      <div class="stock-card">
        <div><strong>${stock.code}</strong></div>
        <div>Lot: ${stock.lot}</div>
        <div>Maliyet: ${formatNumber(stock.cost)}</div>
        <div>GÃ¼ncel DeÄŸer: ${formatNumber(value)}</div>
        <div>Fiyat: <span class="${priceColor}">${formatNumber(price)}</span></div>
        <div>K/Z: <span class="${profitColor}">${formatNumber(profitTL)} (${profitPercent.toFixed(2)}%)</span></div>
      </div>
    `;
  });

  const totalProfitTL = totalValue - totalCost;
  const totalProfitPercent = (totalProfitTL / totalCost) * 100;

  document.getElementById("totalValue").innerText = "Toplam DeÄŸer: " + formatNumber(totalValue);
  document.getElementById("totalProfit").innerHTML =
    "Toplam Kar: <span class='" + (totalProfitTL>=0?"positive":"negative") + "'>" +
    formatNumber(totalProfitTL) + " (" + totalProfitPercent.toFixed(2) + "%)</span>";

  document.getElementById("lastUpdate").innerText =
    "Son Yenilenme: " + new Date().toLocaleTimeString("tr-TR");
}

// ---------------------
// HÄ°SSE EKLE
// ---------------------
document.getElementById("addStockBtn").addEventListener("click",()=>{
  const code = prompt("Hisse Kodu Girin (Ã¶r: THYAO)").toUpperCase();
  const lot = parseFloat(prompt("Lot sayÄ±sÄ± girin"));
  const price = parseFloat(prompt("Hisse baÅŸÄ± fiyat girin (TL)"));
  if(!code || !lot || !price){ alert("GeÃ§erli deÄŸerler girin!"); return; }
  const cost = lot * price;
  portfolio.push({code, lot, cost});
  localStorage.setItem("portfolio", JSON.stringify(portfolio));
  updatePortfolio();
});

// ---------------------
// BAÅžLAT
// ---------------------
updateClock();
setInterval(updateClock,1000);
updatePortfolio();
setInterval(updatePortfolio,60000);
</script>
</body>
</html>
