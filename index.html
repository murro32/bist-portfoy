<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: Arial;
    background: #0f172a;
    color: white;
    margin: 0;
    padding: 15px;
  }
  h1 { text-align: center; }
  .card {
    background: #1e293b;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    overflow-x:auto;
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .timebox {
    text-align: right;
    font-size: 13px;
    opacity: 0.8;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px;
  }
  th, td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #334155;
    white-space: nowrap;
  }
  th { background: #334155; }
  tr:nth-child(even) { background: #1e293b; }
  .positive { color: #22c55e; }
  .negative { color: #ef4444; }
  .big { font-size: 22px; font-weight: bold; }
  button {
    padding: 10px;
    width: 100%;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
  }
  button:hover { background: #1d4ed8; }
  .weekly-table { overflow-x:auto; }
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="topbar">
    <div>
      <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
      <div class="big" id="totalProfit">Toplam Kar: -</div>
    </div>
    <div class="timebox">
      <div id="liveClock"></div>
      <div id="lastUpdate"></div>
    </div>
  </div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet(TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri(TL)</th>
  <th>AnlÄ±k Fiyat(TL)</th>
  <th>K/Z(TL)</th>
  <th>K/Z(%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
<button onclick="saveWeekly()">HaftayÄ± Kaydet</button>
<div class="weekly-table">
<table id="weeklyTable" style="min-width:700px;">
  <thead id="weeklyHead"></thead>
  <tbody id="weeklyBody"></tbody>
</table>
</div>
</div>

<script>
const portfolio = [
  { code: "THYAO", lot: 50, cost: 11930.00 },
  { code: "TUPRS", lot: 70, cost: 8649.90 },
  { code: "ASELS", lot: 50, cost: 3180.50 }
];

function formatNumber(num) {
  return num.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").innerText = "AnlÄ±k Saat: " + now.toLocaleTimeString();
}

async function fetchPrices(symbols) {
  try {
    const response = await fetch(`/api/price?symbols=${symbols}`);
    const prices = await response.json();
    window.latestPrices = prices;
    return prices;
  } catch {
    window.latestPrices = null;
    return null;
  }
}

async function updatePortfolioAndPrices() {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map(s => s.code).join(",");
  const prices = await fetchPrices(symbols);
  if (!prices) {
    tbody.innerHTML = "<tr><td colspan='7'>Veri alÄ±namadÄ±</td></tr>";
    document.getElementById("totalValue").innerText = "API HatasÄ±";
    return;
  }

  tbody.innerHTML = "";
  let totalValue = 0;
  let totalCost = 0;

  for (let stock of portfolio) {
    const price = prices[stock.code];
    if (!price) continue;

    const value = price * stock.lot;
    const profitTL = value - stock.cost;
    const profitPercent = (profitTL / stock.cost) * 100;

    totalValue += value;
    totalCost += stock.cost;

    tbody.innerHTML += `
      <tr>
        <td>${stock.code}</td>
        <td>${stock.lot}</td>
        <td>${formatNumber(stock.cost)}</td>
        <td>${formatNumber(value)}</td>
        <td>${formatNumber(price)}</td>
        <td class="${profitTL >= 0 ? "positive" : "negative"}">${formatNumber(profitTL)}</td>
        <td class="${profitPercent >= 0 ? "positive" : "negative"}">${profitPercent.toFixed(2)}%</td>
      </tr>`;
  }

  const totalProfitTL = totalValue - totalCost;
  const totalProfitPercent = (totalProfitTL / totalCost) * 100;
  document.getElementById("totalValue").innerText = "Toplam DeÄŸer: " + formatNumber(totalValue);
  document.getElementById("totalProfit").innerHTML =
    "Toplam Kar: <span class='" + (totalProfitTL >= 0 ? "positive" : "negative") + "'>" +
    formatNumber(totalProfitTL) + " (" + totalProfitPercent.toFixed(2) + "%)</span>";

  document.getElementById("lastUpdate").innerText = "Son Yenilenme: " + new Date().toLocaleTimeString();
  renderWeeklyTable();
}

// HaftalÄ±k veriyi localStorage'dan al veya boÅŸ obje oluÅŸtur
function getWeeklyData() {
  return JSON.parse(localStorage.getItem("weeklyData") || "{}");
}
function setWeeklyData(data) {
  localStorage.setItem("weeklyData", JSON.stringify(data));
}

function renderWeeklyTable() {
  const weeklyData = getWeeklyData();
  const weeklyHead = document.getElementById("weeklyHead");
  const weeklyBody = document.getElementById("weeklyBody");

  const dates = Object.keys(weeklyData).sort((a,b) => new Date(a) - new Date(b));
  if (dates.length === 0) {
    weeklyHead.innerHTML = "<tr><th>AnlÄ±k Hisse DeÄŸeri(TL)</th><th>HenÃ¼z kayÄ±t yok</th></tr>";
    weeklyBody.innerHTML = "";
    return;
  }

  let headerRow = "<tr><th>Hisse</th>";
  for (let date of dates) {
    headerRow += `<th>${new Date(date).toLocaleDateString("tr-TR")}</th>`;
  }
  headerRow += "</tr>";
  weeklyHead.innerHTML = headerRow;

  let rows = "";
  for (let stock of portfolio) {
    rows += `<tr><td>${stock.code}</td>`;
    for (let i = 0; i < dates.length; i++) {
      const date = dates[i];
      const value = weeklyData[date]?.[stock.code];
      if (value === undefined) {
        rows += "<td>-</td>";
      } else {
        let className = "";
        if (i > 0) {
          const prevValue = weeklyData[dates[i-1]]?.[stock.code];
          if (prevValue !== undefined) className = value > prevValue ? "positive" : (value < prevValue ? "negative" : "");
        }
        rows += `<td class="${className}">${formatNumber(value)}</td>`;
      }
    }
    rows += "</tr>";
  }
  weeklyBody.innerHTML = rows;
}

function saveWeekly() {
  if (!window.latestPrices) {
    alert("GÃ¼ncel fiyatlar henÃ¼z yÃ¼klenmedi, lÃ¼tfen bekleyin.");
    return;
  }
  const todayKey = new Date().toISOString().slice(0,10);
  const weeklyData = getWeeklyData();
  if (!weeklyData[todayKey]) weeklyData[todayKey] = {};
  portfolio.forEach(stock => {
    const price = window.latestPrices[stock.code];
    weeklyData[todayKey][stock.code] = price * stock.lot;
  });
  setWeeklyData(weeklyData);
  renderWeeklyTable();
}

updateClock();
setInterval(updateClock,1000);
updatePortfolioAndPrices();
setInterval(updatePortfolioAndPrices,60000);
renderWeeklyTable();

</script>
</body>
</html>
