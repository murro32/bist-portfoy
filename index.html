<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; padding:15px;}
h1 { text-align:center; margin-bottom:20px; }

.card { background:#1e293b; padding:15px; border-radius:10px; margin-bottom:20px; overflow-x:auto; box-shadow:0 4px 10px rgba(0,0,0,0.3);}
table { width:100%; border-collapse:collapse; min-width:700px; table-layout:fixed;}
th, td { padding:10px; text-align:center; border-bottom:1px solid #334155; font-size:13px; white-space:nowrap;}
thead th { position:sticky; top:0; background:#334155; z-index:1;}
tr:nth-child(even){ background:#1e293b; }
tr:hover { background:#334155; transition:0.2s; }
.positive { color:#22c55e; font-weight:bold; }
.negative { color:#ef4444; font-weight:bold; }
.neutral { color:white; }
.big { font-size:22px; font-weight:bold; }
.timebox { text-align:right; font-size:12px; opacity:0.8; margin-top:5px; }
.daily-positive { color:#22c55e; font-weight:bold; }
.daily-negative { color:#ef4444; font-weight:bold; }
.daily-neutral { color:white; }
@media screen and (max-width:768px){
  table { min-width:600px; }
  th, td { padding:8px; font-size:12px; }
}
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
  <div class="big" id="totalProfit">Toplam Kar: -</div>
  <div class="timebox" id="liveClock"></div>
  <div class="timebox" id="lastUpdate"></div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet(TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri(TL)</th>
  <th>AnlÄ±k Fiyat(TL)</th>
  <th>K/Z(TL)</th>
  <th>K/Z(%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
<h3>GÃ¼nlÃ¼k KapanÄ±ÅŸ Logu</h3>
<table>
<thead>
<tr>
<th>Tarih</th>
<th>Toplam DeÄŸer</th>
<th>Toplam Kar/Zarar</th>
</tr>
</thead>
<tbody id="dailyLogTable"></tbody>
</table>
</div>

<script>
// ---------------------
// PORTFÃ–Y
// ---------------------
const portfolio = [
  { code:"THYAO", lot:50, cost:11930.00 },
  { code:"TUPRS", lot:70, cost:8649.90 },
  { code:"ASELS", lot:50, cost:3180.50 }
];

// ---------------------
// FORMAT
// ---------------------
function formatNumber(num) {
  return num.toLocaleString("tr-TR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
}

// ---------------------
// SAAT
// ---------------------
function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").innerText =
    "AnlÄ±k Saat: " + now.toLocaleTimeString("tr-TR");
}

// ---------------------
// API'DEN FÄ°YAT Ã‡EK
// ---------------------
async function fetchPrices(symbols) {
  try {
    const response = await fetch(`https://bist-portfoy.vercel.app/api/price?symbols=${symbols}`);
    return await response.json();
  } catch {
    return null;
  }
}

// ---------------------
// PORTFÃ–Y GÃœNCELLE VE SHEET'E KAYDET
// ---------------------
async function updatePortfolio() {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map(s => s.code).join(",");
  const prices = await fetchPrices(symbols);

  if(!prices){
    tbody.innerHTML = "<tr><td colspan='7'>API HatasÄ±</td></tr>";
    return;
  }

  let totalValue = 0;
  let totalCost = 0;

  tbody.innerHTML = "";

  portfolio.forEach(stock => {
    const stockData = prices[stock.code];
    if(!stockData) return;

    const price = stockData.price;
    const value = price * stock.lot;
    const profitTL = value - stock.cost;
    const profitPercent = (profitTL / stock.cost) * 100;

    totalValue += value;
    totalCost += stock.cost;

    const profitColor = profitTL >= 0 ? "positive" : "negative";

    tbody.innerHTML += `<tr>
      <td>${stock.code}</td>
      <td>${stock.lot}</td>
      <td>${formatNumber(stock.cost)}</td>
      <td>${formatNumber(value)}</td>
      <td class="${profitColor}">${formatNumber(price)}</td>
      <td class="${profitColor}">${formatNumber(profitTL)}</td>
      <td class="${profitColor}">${profitPercent.toFixed(2)}%</td>
    </tr>`;
  });

  const totalProfitTL = totalValue - totalCost;

  document.getElementById("totalValue").innerText =
    "Toplam DeÄŸer: " + formatNumber(totalValue);

  document.getElementById("totalProfit").innerHTML =
    "Toplam Kar: <span class='" +
    (totalProfitTL>=0?"positive":"negative") +
    "'>" + formatNumber(totalProfitTL) + "</span>";

  document.getElementById("lastUpdate").innerText =
    "Son Yenilenme: " + new Date().toLocaleTimeString("tr-TR");

  // Sheet'e POST ile gÃ¶nder
  sendToSheet(totalValue, totalProfitTL);

  // GÃ¼nlÃ¼k logu da gÃ¶ster
  showDailyLogFromSheet();
}

// ---------------------
// SHEET'TEN LOG Ã‡EK
// ---------------------
async function showDailyLogFromSheet() {
  const tbody = document.getElementById("dailyLogTable");
  tbody.innerHTML = "<tr><td colspan='3'>YÃ¼kleniyor...</td></tr>";

  try {
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxLjHUGpIlNbJ6F71LJyaOMpnf1MTDxkIVDLgz3N7h_dB-XCh7S2lfPtmmyIwQhyUy-/exec";
    const response = await fetch(sheetUrl);
    const logData = await response.json();

    tbody.innerHTML = "";

    logData.forEach(item => {
      const profitClass = Number(item.totalProfit) >= 0 ? "daily-positive" : "daily-negative";
      let dateStr = new Date(item.date).toLocaleDateString("tr-TR");
      tbody.innerHTML += `<tr>
        <td>${dateStr}</td>
        <td>${item.totalValue}</td>
        <td class="${profitClass}">${item.totalProfit}</td>
      </tr>`;
    });

  } catch (e) {
    tbody.innerHTML = "<tr><td colspan='3'>Log yÃ¼klenemedi</td></tr>";
    console.error(e);
  }
}

// ---------------------
// SHEET'E POST GÃ–NDER
// ---------------------
async function sendToSheet(totalValue, totalProfit) {
  try {
    const sheetUrl = "https://script.google.com/macros/s/AKfycbxJRGoH6pWWEKoHBn7kU1vLyy5vi73OGJJkBuMJhyazRo2gC8ptPjzUhqO4YRq1BuE8/exec";
    await fetch(sheetUrl, {
      method: "POST",
      body: JSON.stringify({ totalValue, totalProfit }),
      headers: { "Content-Type": "application/json" }
    });
  } catch(e) {
    console.error("Sheet'e gÃ¶nderilemedi", e);
  }
}

// ---------------------
// BAÅžLAT
// ---------------------
updateClock();
setInterval(updateClock,1000);
updatePortfolio();
setInterval(updatePortfolio,60000); // 1 dakikada bir gÃ¼ncelle
</script>

</body>
</html>
