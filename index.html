<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; padding:15px;}
h1 { text-align:center; margin-bottom:20px; }
.card { background:#1e293b; padding:15px; border-radius:10px; margin-bottom:20px; overflow-x:auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
table { width:100%; border-collapse: collapse; min-width:700px; table-layout: fixed; }
th, td { padding:10px; text-align:center; border-bottom:1px solid #334155; font-size:13px; white-space:nowrap; }
thead th { position: sticky; top:0; background:#334155; z-index:1; }
tr:nth-child(even){ background:#1e293b; }
tr:hover { background:#334155; transition:0.2s; }
.positive { color:#22c55e; font-weight:bold; }
.negative { color:#ef4444; font-weight:bold; }
.neutral { color:white; }
.big { font-size:22px; font-weight:bold; }
.timebox { text-align:right; font-size:12px; opacity:0.8; margin-top:5px; }
td span { font-size:10px; color:#94a3b8; display:inline; margin-left:4px; }
.daily-positive { color:#22c55e; font-weight:bold; }
.daily-negative { color:#ef4444; font-weight:bold; }
.daily-neutral { color:white; }
@media screen and (max-width:768px){ table { min-width:600px; } th, td { padding:8px; font-size:12px; } }
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
  <div class="big" id="totalProfit">Toplam Kar: -</div>
  <div class="timebox" id="liveClock"></div>
  <div class="timebox" id="lastUpdate"></div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet(TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri(TL)</th>
  <th>AnlÄ±k Fiyat(TL)</th>
  <th>K/Z(TL)</th>
  <th>K/Z(%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
  <h3>ðŸ“… GÃ¼nlÃ¼k KapanÄ±ÅŸ Logu</h3>
  <table>
    <thead>
      <tr>
        <th>Tarih</th>
        <th>Toplam DeÄŸer</th>
        <th>Toplam Kar/Zarar</th>
      </tr>
    </thead>
    <tbody id="dailyLogTable"></tbody>
  </table>
</div>

<script>
const portfolio = [
  { code:"THYAO", lot:50, cost:11930.00 },
  { code:"TUPRS", lot:70, cost:8649.90 },
  { code:"ASELS", lot:50, cost:3180.50 },
  { code:"ENERY", lot:2544.83, cost:5547.72 },
  { code:"ALARK", lot:50, cost:6178.50 },
  { code:"MIATK", lot:100, cost:4564.00 },
  { code:"PETKM", lot:200, cost:3664.00 },
  { code:"JANTS", lot:198.31, cost:7139.20 },
  { code:"FZLGY", lot:204.40, cost:461.95 },
  { code:"TABGD", lot:9, cost:1138.68 },
  { code:"SKTAS", lot:650.19, cost:1176.85 },
  { code:"IZENR", lot:212.50, cost:1651.12 },
  { code:"ASUZU", lot:30, cost:1532.40 },
  { code:"BASGZ", lot:40, cost:556.40 },
  { code:"CANTE", lot:1065.96, cost:2121.27 },
  { code:"AKSEN", lot:25, cost:1007.75 },
  { code:"PENTA", lot:100, cost:1977.00 },
  { code:"AVPGY", lot:26, cost:1249.30 },
  { code:"KLSER", lot:49, cost:1216.67 },
  { code:"KONTR", lot:135, cost:7210.35 },
  { code:"LMKDC", lot:36, cost:582.60 },
  { code:"ENTRA", lot:85, cost:850.00 },
  { code:"TATEN", lot:88, cost:495.44 },
  { code:"ENJSA", lot:5, cost:292.80 },
  { code:"GIPTA", lot:9, cost:178.11 },
  { code:"EKOS", lot:72, cost:230.40 },
  { code:"REEDR", lot:69, cost:427.80 },
  { code:"HATSN", lot:9, cost:203.40 },
  { code:"MHRGY", lot:99, cost:281.16 },
  { code:"MEKAG", lot:64, cost:124.80 },
  { code:"BORLS", lot:41.49, cost:248.13 }
];

function formatNumber(num) { 
  if(typeof num === "string") num = parseFloat(num.replace(",",""));
  return num.toLocaleString("tr-TR",{ minimumFractionDigits:2, maximumFractionDigits:2 }); 
}

function updateClock() { document.getElementById("liveClock").innerText = "AnlÄ±k Saat: " + new Date().toLocaleTimeString("tr-TR"); }

async function fetchPrices(symbols) {
  try {
    const response = await fetch(`https://bist-portfoy.vercel.app/api/price?symbols=${symbols}`);
    return await response.json();
  } catch { return null; }
}

async function updatePortfolio() {
  const tbody = document.getElementById("portfolioBody");
  const symbols = portfolio.map(s => s.code).join(",");
  const prices = await fetchPrices(symbols);
  
  if(!prices){ tbody.innerHTML = "<tr><td colspan='7'>API HatasÄ±</td></tr>"; return; }

  let totalValue = 0, totalCost = 0, html = "";
  let data = [];

  portfolio.forEach(stock => {
    const sData = prices[stock.code];
    if(!sData) return;
    const value = sData.price * stock.lot;
    data.push({...stock, price: sData.price, prev: sData.prevClose, value: value, profit: value - stock.cost});
  });

  data.sort((a,b) => b.value - a.value);

  data.forEach(s => {
    totalValue += s.value; totalCost += s.cost;
    const pColor = s.profit >= 0 ? "positive" : "negative";
    const ref = s.prev || s.price;
    const diff = ((s.price - ref)/ref)*100;
    html += `<tr><td>${s.code}</td><td>${s.lot}</td><td>${formatNumber(s.cost)}</td><td>${formatNumber(s.value)}</td>
    <td class="${s.price >= ref ? 'positive' : 'negative'}">${formatNumber(s.price)}<span>(${diff.toFixed(2)}%)</span></td>
    <td class="${pColor}">${formatNumber(s.profit)}</td><td class="${pColor}">${((s.profit/s.cost)*100).toFixed(2)}%</td></tr>`;
  });

  tbody.innerHTML = html;
  document.getElementById("totalValue").innerText = "Toplam DeÄŸer: " + formatNumber(totalValue);
  const tProfit = totalValue - totalCost;
  document.getElementById("totalProfit").innerHTML = `Toplam Kar: <span class="${tProfit>=0?'positive':'negative'}">${formatNumber(tProfit)} (${((tProfit/totalCost)*100).toFixed(2)}%)</span>`;
  document.getElementById("lastUpdate").innerText = "Son Yenilenme: " + new Date().toLocaleTimeString("tr-TR");
  
  showDailyLog();
}

function showDailyLog() {
  google.script.run.withSuccessHandler(function(data) {
    const tbody = document.getElementById("dailyLogTable");
    if(!data || data.length === 0) { tbody.innerHTML = "<tr><td colspan='3'>KayÄ±t yok.</td></tr>"; return; }
    tbody.innerHTML = data.reverse().map(item => `
      <tr><td>${item.date}</td><td>${formatNumber(item.totalValue)}</td>
      <td class="${String(item.totalProfit).includes('-') ? 'daily-negative' : 'daily-positive'}">${formatNumber(item.totalProfit)}</td></tr>
    `).join("");
  }).getSheetDataForLog();
}

updateClock(); setInterval(updateClock,1000);
updatePortfolio(); setInterval(updatePortfolio,60000);
</script>
</body>
</html>
