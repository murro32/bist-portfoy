<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: Arial; background:#0f172a; color:white; margin:0; padding:15px;}
h1 { text-align:center; }
.card { background:#1e293b; padding:15px; border-radius:10px; margin-bottom:15px; overflow-x:auto; }
table { width:100%; border-collapse: collapse; min-width:700px; }
th, td { padding:8px; text-align:center; border-bottom:1px solid #334155; white-space: nowrap; }
th { background:#334155; }
tr:nth-child(even){background:#1e293b;}
.positive { color:#22c55e; }
.negative { color:#ef4444; }
.big { font-size:22px; font-weight:bold; }
.timebox { text-align:right; font-size:13px; opacity:0.8; }
button { padding:10px; width:100%; background:#2563eb; color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;}
button:hover { background:#1d4ed8; }
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
  <div class="big" id="totalProfit">Toplam Kar: -</div>
  <div class="timebox" id="liveClock"></div>
  <div class="timebox" id="lastUpdate"></div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet(TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri(TL)</th>
  <th>AnlÄ±k Fiyat(TL)</th>
  <th>K/Z(TL)</th>
  <th>K/Z(%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
<h3>GÃ¼nlÃ¼k PortfÃ¶y KaydÄ±</h3>
<div class="weekly-table">
<table id="dailyTable">
  <thead id="dailyHead"></thead>
  <tbody id="dailyBody"></tbody>
</table>
</div>
</div>

<script>
// ---------------------
// PortfÃ¶y
const portfolio = [
  { code:"THYAO", lot:50, cost:11930.00 },
  { code:"TUPRS", lot:70, cost:8649.90 },
  { code:"ASELS", lot:50, cost:3180.50 },
  { code:"ENERY", lot:2544.83, cost:5547.72 }, 
  { code:"ALARK", lot:50, cost:6178.50 }, 
  { code:"MIATK", lot:100, cost:4564.00 },
  { code:"PETKM", lot:200, cost:3664.00 }
];

// TÃ¼rkÃ§e sayÄ± formatÄ±
function formatNumber(num) {
  return num.toLocaleString("tr-TR",{ minimumFractionDigits:2, maximumFractionDigits:2 });
}

// AnlÄ±k saat
function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").innerText = "AnlÄ±k Saat: " + now.toLocaleTimeString();
}

// ---------------------
// CanlÄ± fiyatlarÄ± APIâ€™den al
async function fetchPrices(symbols) {
  try {
    const response = await fetch(`/api/price?symbols=${symbols}`);
    const prices = await response.json();
    window.latestPrices = prices;
    return prices;
  } catch {
    window.latestPrices = null;
    return null;
  }
}

// ---------------------
// PortfÃ¶y tablosunu gÃ¼ncelle
async function updatePortfolio() {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map(s => s.code).join(",");
  const prices = await fetchPrices(symbols);
  if(!prices){
    tbody.innerHTML = "<tr><td colspan='7'>Veri alÄ±namadÄ±</td></tr>";
    document.getElementById("totalValue").innerText = "API HatasÄ±";
    return;
  }

  // PortfÃ¶y verilerini hesapla
  const data = portfolio.map(stock => {
    const price = prices[stock.code];
    
    // Ä°lk gelen fiyat aÃ§Ä±lÄ±ÅŸ fiyatÄ± olarak kaydediliyor
    if(!stock.openPrice) stock.openPrice = price;

    const value = price * stock.lot;
    const profitTL = value - stock.cost;
    const profitPercent = (profitTL / stock.cost) * 100;
    return { ...stock, price, value, profitTL, profitPercent };
  });

  // GÃ¼ncel Hisse DeÄŸeri bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe sÄ±rala
  data.sort((a,b) => b.value - a.value);

  tbody.innerHTML = "";
  let totalValue = 0;
  let totalCost = 0;
  for (let stock of data){
    totalValue += stock.value;
    totalCost += stock.cost;
    tbody.innerHTML += `
      <tr>
        <td>${stock.code}</td>
        <td>${stock.lot}</td>
        <td>${formatNumber(stock.cost)}</td>
        <td>${formatNumber(stock.value)}</td>
        <td class="${stock.price > stock.openPrice ? 'positive' : (stock.price < stock.openPrice ? 'negative' : '')}">
          ${formatNumber(stock.price)}
        </td>
        <td class="${stock.profitTL>=0?'positive':'negative'}">${formatNumber(stock.profitTL)}</td>
        <td class="${stock.profitPercent>=0?'positive':'negative'}">${stock.profitPercent.toFixed(2)}%</td>
      </tr>`;
  }

  const totalProfitTL = totalValue - totalCost;
  const totalProfitPercent = (totalProfitTL / totalCost)*100;
  document.getElementById("totalValue").innerText = "Toplam DeÄŸer: " + formatNumber(totalValue);
  document.getElementById("totalProfit").innerHTML = 
    "Toplam Kar: <span class='"+(totalProfitTL>=0?'positive':'negative')+"'>"+formatNumber(totalProfitTL)+" ("+totalProfitPercent.toFixed(2)+"%)</span>";

  document.getElementById("lastUpdate").innerText = "Son Yenilenme: " + new Date().toLocaleTimeString();

  // GÃ¼nlÃ¼k 18:30 kaydÄ±nÄ± kontrol et
  tryDailyEndOfDaySave(data);
}

// ---------------------------
// GÃ¼nlÃ¼k 18:30 kaydÄ±
function tryDailyEndOfDaySave(currentData){
  const now = new Date();
  const hour = now.getHours();
  const minute = now.getMinutes();

  // Saat 18:30 civarÄ±nda Ã§alÄ±ÅŸacak
  if(hour === 18 && minute === 30){
    const dailyLog = JSON.parse(localStorage.getItem("dailyLog") || "{}");
    const dateKey = now.toISOString().split("T")[0]; // yyyy-mm-dd

    if(dailyLog[dateKey]) return;

    dailyLog[dateKey] = {};
    currentData.forEach(stock => {
      dailyLog[dateKey][stock.code] = stock.value;
    });

    localStorage.setItem("dailyLog", JSON.stringify(dailyLog));
    console.log("ðŸ“ˆ GÃ¼nlÃ¼k 18:30 kaydÄ± alÄ±ndÄ±:", dateKey);
    renderDailyTable(dailyLog);
  }
}

// ---------------------------
// GÃ¼nlÃ¼k tablo render
function renderDailyTable(dailyLog){
  const dailyTable = document.getElementById("dailyTable");
  if(!dailyTable) return;

  const dates = Object.keys(dailyLog).sort();
  
  // BaÅŸlÄ±k
  let headerRow = "<tr><th>Hisse</th>";
  dates.forEach(date=>{
    headerRow += `<th>${new Date(date).toLocaleDateString("tr-TR")} 18:30</th>`;
  });
  headerRow += "</tr>";
  document.getElementById("dailyHead").innerHTML = headerRow;

  // Body
  let rows = "";
  portfolio.forEach(stock => {
    rows += `<tr><td>${stock.code}</td>`;
    dates.forEach((date,i)=>{
      const value = dailyLog[date][stock.code];
      let className = "";
      if(i>0){
        const prev = dailyLog[dates[i-1]][stock.code];
        if(value>prev) className="positive";
        else if(value<prev) className="negative";
      }
      rows += `<td class="${className}">${formatNumber(value)}</td>`;
    });
    rows += "</tr>";
  });
  document.getElementById("dailyBody").innerHTML = rows;
}

// ---------------------
// BaÅŸlangÄ±Ã§
updateClock();
setInterval(updateClock,1000);
updatePortfolio();
setInterval(updatePortfolio,60000); // her dakika gÃ¼ncelle
</script>

</body>
</html>
