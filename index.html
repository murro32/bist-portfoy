<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    font-family: Arial;
    background: #0f172a;
    color: white;
    margin: 0;
    padding: 15px;
  }
  h1 {
    text-align: center;
  }
  .card {
    background: #1e293b;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
    overflow-x:auto;
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
  }
  .timebox {
    text-align: right;
    font-size: 13px;
    opacity: 0.8;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }
  th, td {
    padding: 8px;
    text-align: center;
    border-bottom: 1px solid #334155;
    white-space: nowrap;
  }
  th {
    background: #334155;
  }
  tr:nth-child(even) {
    background: #1e293b;
  }
  .positive {
    color: #22c55e;
  }
  .negative {
    color: #ef4444;
  }
  .big {
    font-size: 22px;
    font-weight: bold;
  }
  button {
    padding: 10px;
    width: 100%;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
  }
  button:hover {
    background: #1d4ed8;
  }
  .weekly-table {
    overflow-x:auto;
  }
</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="topbar">
    <div>
      <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
      <div class="big" id="totalProfit">Toplam Kar: -</div>
    </div>
    <div class="timebox">
      <div id="liveClock"></div>
      <div id="lastUpdate"></div>
    </div>
  </div>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Hisse</th>
  <th>Lot</th>
  <th>Maliyet (TL)</th>
  <th>GÃ¼ncel Hisse DeÄŸeri (TL)</th>
  <th>AnlÄ±k Fiyat</th>
  <th>K/Z (TL)</th>
  <th>K/Z (%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
<button onclick="saveWeekly()">HaftayÄ± Kaydet</button>
<div class="weekly-table">
<table id="weeklyTable" style="min-width:700px;">
  <thead id="weeklyHead"></thead>
  <tbody id="weeklyBody"></tbody>
</table>
</div>
</div>

<script>
const portfolio = [
  { code: "THYAO", lot: 50, cost: 11930.00 },
  { code: "TUPRS", lot: 70, cost: 8649.90 },
  { code: "ASELS", lot: 50, cost: 3180.50 }
];

// Format TL sayÄ±, TÃ¼rkÃ§e locale ile, ondalÄ±klÄ±, ama TL yazmaz (sadece sayÄ±)
function formatNumber(num) {
  return num.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Format TL yazanlar iÃ§in (TL ekler)
function formatTL(num) {
  return formatNumber(num) + " TL";
}

function updateClock() {
  const now = new Date();
  document.getElementById("liveClock").innerText = "AnlÄ±k Saat: " + now.toLocaleTimeString();
}

async function updatePortfolio() {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map((s) => s.code).join(",");

  try {
    const response = await fetch(`/api/price?symbols=${symbols}`);
    const prices = await response.json();

    tbody.innerHTML = "";

    let totalValue = 0;
    let totalCost = 0;

    for (let stock of portfolio) {
      const price = prices[stock.code];

      if (!price) {
        tbody.innerHTML += `
          <tr>
            <td>${stock.code}</td>
            <td colspan="6">Veri alÄ±namadÄ±</td>
          </tr>`;
        continue;
      }

      const value = price * stock.lot;
      const profitTL = value - stock.cost;
      const profitPercent = (profitTL / stock.cost) * 100;

      totalValue += value;
      totalCost += stock.cost;

      tbody.innerHTML += `
      <tr>
        <td>${stock.code}</td>
        <td>${stock.lot}</td>
        <td>${formatTL(stock.cost)}</td>
        <td>${formatTL(value)}</td>
        <td>${formatNumber(price)}</td>
        <td class="${profitTL >= 0 ? "positive" : "negative"}">${formatTL(profitTL)}</td>
        <td class="${profitPercent >= 0 ? "positive" : "negative"}">${profitPercent.toFixed(2)}%</td>
      </tr>`;
    }

    const totalProfitTL = totalValue - totalCost;
    const totalProfitPercent = (totalProfitTL / totalCost) * 100;

    document.getElementById("totalValue").innerText =
      "Toplam DeÄŸer: " + formatTL(totalValue);

    document.getElementById("totalProfit").innerHTML =
      "Toplam Kar: <span class='" + (totalProfitTL >= 0 ? "positive" : "negative") + "'>" +
      formatTL(totalProfitTL) + " (" + totalProfitPercent.toFixed(2) + "%)</span>";

    document.getElementById("lastUpdate").innerText =
      "Son Yenilenme: " + new Date().toLocaleTimeString();

    // HaftalÄ±k tabloyu gÃ¼ncelle
    renderWeeklyTable();

  } catch (error) {
    document.getElementById("totalValue").innerText = "API HatasÄ±";
    tbody.innerHTML = "<tr><td colspan='7'>Veri alÄ±namadÄ±</td></tr>";
  }
}

// LocalStorage'dan haftalÄ±k veriyi oku veya boÅŸ obje dÃ¶ndÃ¼r
function getWeeklyData() {
  return JSON.parse(localStorage.getItem("weeklyData") || "{}");
}

// HaftalÄ±k veriyi kaydet
function setWeeklyData(data) {
  localStorage.setItem("weeklyData", JSON.stringify(data));
}

// HaftalÄ±k tabloyu oluÅŸtur
function renderWeeklyTable() {
  const weeklyData = getWeeklyData();
  const weeklyHead = document.getElementById("weeklyHead");
  const weeklyBody = document.getElementById("weeklyBody");

  // SÃ¼tun baÅŸlÄ±klarÄ±: Ã¶nce "AnlÄ±k Hisse DeÄŸeri (TL)" sonra tarih sÃ¼tunlarÄ± (sÄ±ralÄ±)
  let dates = Object.keys(weeklyData).sort((a, b) => new Date(a) - new Date(b));
  if (dates.length === 0) {
    weeklyHead.innerHTML = "<tr><th>AnlÄ±k Hisse DeÄŸeri (TL)</th><th>HenÃ¼z kayÄ±t yok</th></tr>";
    weeklyBody.innerHTML = "";
    return;
  }

  // BaÅŸlÄ±k satÄ±rÄ±
  let headerRow = "<tr><th>Hisse</th>";
  for (let date of dates) {
    // Tarih formatÄ±: gg.aa.yyyy
    const dt = new Date(date);
    const formattedDate = dt.toLocaleDateString("tr-TR");
    headerRow += `<th>${formattedDate}</th>`;
  }
  headerRow += "</tr>";
  weeklyHead.innerHTML = headerRow;

  // SatÄ±rlarÄ± hisse bazÄ±nda oluÅŸtur
  let rows = "";
  for (let stock of portfolio) {
    rows += `<tr><td>${stock.code}</td>`;

    for (let i = 0; i < dates.length; i++) {
      const date = dates[i];
      const valuesForDate = weeklyData[date] || {};
      const currentValue = valuesForDate[stock.code];

      if (currentValue === undefined) {
        rows += "<td>-</td>";
      } else {
        // Renk kontrolÃ¼: Ã–nceki gÃ¼n ile karÅŸÄ±laÅŸtÄ±r
        let className = "";
        if (i > 0) {
          const prevDate = dates[i - 1];
          const prevValue = weeklyData[prevDate]?.[stock.code];
          if (prevValue !== undefined) {
            className = currentValue > prevValue ? "positive" : (currentValue < prevValue ? "negative" : "");
          }
        }
        rows += `<td class="${className}">${formatNumber(currentValue)}</td>`;
      }
    }
    rows += "</tr>";
  }
  weeklyBody.innerHTML = rows;
}

// HaftalÄ±k veriyi kaydet (bugÃ¼nÃ¼n tarihi ve o anki gÃ¼ncel hisse deÄŸeri)
function saveWeekly() {
  const today = new Date();
  const todayKey = today.toISOString().slice(0, 10); // yyyy-mm-dd formatÄ±

  const weeklyData = getWeeklyData();

  if (!weeklyData[todayKey]) weeklyData[todayKey] = {};

  // GÃ¼ncel hisse deÄŸerleri alÄ±nÄ±r
  const tbody = document.getElementById("portfolioBody");
  // portfolio array'inden koda gÃ¶re fiyatlarÄ± bulacaÄŸÄ±z

  portfolio.forEach(stock => {
    // GÃ¼ncel deÄŸeri tabloya gÃ¶re alÄ±yoruz, fiyat deÄŸil, deÄŸer (lot x fiyat)
    // Ancak bizim tabloda hÃ¼cre yoksa - koyuyoruz, kontrol et
    // Alternatif: En son fetch edilen fiyatlarÄ± saklamak lazÄ±m
    // Biz burada prices objesini global yapabiliriz:
  });

  // GÃ¼ncel fiyatlarÄ± globalde tutuyoruz ki burda kullanalÄ±m
  // EÄŸer yoksa uyarÄ± ver
  if (!window.latestPrices) {
    alert("GÃ¼ncel fiyatlar henÃ¼z yÃ¼klenmedi, lÃ¼tfen bekleyin.");
    return;
  }

  // BugÃ¼nÃ¼n hisse deÄŸerini hesaplayÄ±p kaydet
  portfolio.forEach(stock => {
    const price = window.latestPrices[stock.code];
    if (!price) return;
    const value = price * stock.lot;
    weeklyData[todayKey][stock.code] = value;
  });

  setWeeklyData(weeklyData);
  renderWeeklyTable();
}

async function fetchPrices(symbols) {
  try {
    const response = await fetch(`/api/price?symbols=${symbols}`);
    const prices = await response.json();
    window.latestPrices = prices; // globalde tut
    return prices;
  } catch {
    window.latestPrices = null;
    return null;
  }
}

async function updatePortfolioAndPrices() {
  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML = "<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map((s) => s.code).join(",");
  const prices = await fetchPrices(symbols);
  if (!prices) {
    document.getElementById("totalValue").innerText = "API HatasÄ±";
    tbody.innerHTML = "<tr><td colspan='7'>Veri alÄ±namadÄ±</td></tr>";
    return;
  }

  tbody.innerHTML = "";

  let totalValue = 0;
  let totalCost = 0;

  for (let stock of portfolio) {
    const price = prices[stock.code];

    if (!price) {
      tbody.innerHTML += `
        <tr>
          <td>${stock.code}</td>
          <td colspan="6">Veri alÄ±namadÄ±</td>
        </tr>`;
      continue;
    }

    const value = price * stock.lot;
    const profitTL = value - stock.cost;
    const profitPercent = (profitTL / stock.cost) * 100;

    totalValue += value;
    totalCost += stock.cost;

    tbody.innerHTML += `
      <tr>
        <td>${stock.code}</td>
        <td>${stock.lot}</td>
        <td>${formatTL(stock.cost)}</td>
        <td>${formatTL(value)}</td>
        <td>${formatNumber(price)}</td>
        <td class="${profitTL >= 0 ? "positive" : "negative"}">${formatTL(profitTL)}</td>
        <td class="${profitPercent >= 0 ? "positive" : "negative"}">${profitPercent.toFixed(2)}%</td>
      </tr>`;
  }

  const totalProfitTL = totalValue - totalCost;
  const totalProfitPercent = (totalProfitTL / totalCost) * 100;

  document.getElementById("totalValue").innerText =
    "Toplam DeÄŸer: " + formatTL(totalValue);

  document.getElementById("totalProfit").innerHTML =
    "Toplam Kar: <span class='" + (totalProfitTL >= 0 ? "positive" : "negative") + "'>" +
    formatTL(totalProfitTL) + " (" + totalProfitPercent.toFixed(2) + "%)</span>";

  document.getElementById("lastUpdate").innerText =
    "Son Yenilenme: " + new Date().toLocaleTimeString();

  // HaftalÄ±k tablo gÃ¼ncellendi
  renderWeeklyTable();
}

updateClock();
setInterval(updateClock, 1000);

updatePortfolioAndPrices();
setInterval(updatePortfolioAndPrices, 60000);

renderWeeklyTable();

</script>
</body>
</html>
