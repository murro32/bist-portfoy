<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BIST PortfÃ¶y Takip</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { 
  font-family: Arial; 
  background:#0f172a; 
  color:white; 
  margin:0; 
  padding:15px;
}

h1 { text-align:center; }

.card { 
  background:#1e293b; 
  padding:15px; 
  border-radius:10px; 
  margin-bottom:15px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
}

.timebox{
  text-align:right;
  font-size:13px;
  opacity:0.8;
}

table { 
  width:100%; 
  border-collapse: collapse; 
}

th, td { 
  padding:8px; 
  text-align:center; 
}

th { background:#334155; }

tr:nth-child(even){ background:#1e293b; }

.positive { color:#22c55e; }
.negative { color:#ef4444; }

.big { 
  font-size:22px; 
  font-weight:bold; 
}

button { 
  padding:10px; 
  width:100%; 
  background:#2563eb; 
  color:white; 
  border:none; 
  border-radius:8px; 
  margin-top:10px; 
  cursor:pointer;
}

button:hover { background:#1d4ed8; }

</style>
</head>
<body>

<h1>ðŸ“Š PortfÃ¶y Takip</h1>

<div class="card">
  <div class="topbar">
    <div>
      <div class="big" id="totalValue">Toplam DeÄŸer: YÃ¼kleniyor...</div>
      <div class="big" id="totalProfit">Toplam Kar: -</div>
    </div>
    <div class="timebox">
      <div id="liveClock"></div>
      <div id="lastUpdate"></div>
    </div>
  </div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Hisse</th>
<th>Lot</th>
<th>Maliyet (TL)</th>
<th>GÃ¼ncel Hisse DeÄŸeri (TL)</th>
<th>AnlÄ±k Fiyat (TL)</th>
<th>K/Z (TL)</th>
<th>K/Z (%)</th>
</tr>
</thead>
<tbody id="portfolioBody"></tbody>
</table>
</div>

<div class="card">
<button onclick="saveWeekly()">HaftayÄ± Kaydet</button>
<div id="weeklyLog"></div>
</div>

<script>

const portfolio = [
  { code:"THYAO", lot:50, cost:11930.00 },
  { code:"TUPRS", lot:70, cost:8649.90 },
  { code:"ASELS", lot:50, cost:3180.50 }
];

function formatTL(number){
  return number.toLocaleString("tr-TR", {minimumFractionDigits:2, maximumFractionDigits:2});
}

function updateClock(){
  const now = new Date();
  document.getElementById("liveClock").innerText =
    "AnlÄ±k Saat: " + now.toLocaleTimeString();
}

async function updatePortfolio(){

  const tbody = document.getElementById("portfolioBody");
  tbody.innerHTML="<tr><td colspan='7'>YÃ¼kleniyor...</td></tr>";

  const symbols = portfolio.map(s => s.code).join(",");

  try{

    const response = await fetch(`/api/price?symbols=${symbols}`);
    const prices = await response.json();

    tbody.innerHTML="";

    let totalValue=0;
    let totalCost=0;

    for(let stock of portfolio){

      const price = prices[stock.code];

      if(!price){
        tbody.innerHTML += `
        <tr>
        <td>${stock.code}</td>
        <td colspan="6">Veri alÄ±namadÄ±</td>
        </tr>`;
        continue;
      }

      const value = price * stock.lot;
      const profitTL = value - stock.cost;
      const profitPercent = (profitTL / stock.cost) * 100;

      totalValue += value;
      totalCost += stock.cost;

      tbody.innerHTML += `
      <tr>
      <td>${stock.code}</td>
      <td>${stock.lot}</td>
      <td>${formatTL(stock.cost)} TL</td>
      <td>${formatTL(value)} TL</td>
      <td>${formatTL(price)} TL</td>
      <td class="${profitTL>=0?'positive':'negative'}">${formatTL(profitTL)} TL</td>
      <td class="${profitPercent>=0?'positive':'negative'}">${profitPercent.toFixed(2)}%</td>
      </tr>`;
    }

    const totalProfitTL = totalValue - totalCost;
    const totalProfitPercent = (totalProfitTL / totalCost) * 100;

    document.getElementById("totalValue").innerText =
      "Toplam DeÄŸer: " + formatTL(totalValue) + " TL";

    document.getElementById("totalProfit").innerHTML =
      "Toplam Kar: <span class='"+(totalProfitTL>=0?'positive':'negative')+"'>" +
      formatTL(totalProfitTL) + " TL (" + totalProfitPercent.toFixed(2) + "%)</span>";

    document.getElementById("lastUpdate").innerText =
      "Son Yenilenme: " + new Date().toLocaleTimeString();

  }catch(error){

    document.getElementById("totalValue").innerText="API HatasÄ±";
    tbody.innerHTML="<tr><td colspan='7'>Veri alÄ±namadÄ±</td></tr>";
  }
}

function saveWeekly(){
  const today = new Date().toLocaleDateString();
  const value = document.getElementById("totalValue").innerText;
  const log = JSON.parse(localStorage.getItem("weekly") || "[]");
  log.push({date:today, value:value});
  localStorage.setItem("weekly", JSON.stringify(log));
  showWeekly();
}

function showWeekly(){
  const log = JSON.parse(localStorage.getItem("weekly") || "[]");
  const div = document.getElementById("weeklyLog");
  div.innerHTML="<h3>HaftalÄ±k KayÄ±t</h3>";
  log.forEach(item=>{
    div.innerHTML += `<div>${item.date} - ${item.value}</div>`;
  });
}

updateClock();
setInterval(updateClock,1000);

updatePortfolio();
showWeekly();
setInterval(updatePortfolio,60000);

</script>

</body>
</html>
